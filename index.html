<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Klinfys.nu</title>
  <link rel="stylesheet" href="looks3.css" />
</head>
<body>

<div id="left">
  <img src="one.gif" id="bubble" alt="AI-bild" />

  <div id="chat"></div>

  <form id="form" autocomplete="off">
    <input type="text" id="input" placeholder="Ställ din fråga här…" />
    <button type="submit">Skicka</button>
  </form>
</div>

<div id="nav"> 
  <input type="button" class="hemknapp" value="HEM">

  <div class="container-dd1"> 
    <nav class="kf">KLINISK FYSIOLOGI</nav>
    <div class="dropdown">
      <a href="#">VILO-EKG</a>
      <a href="#">LÅNGTIDS-EKG</a>
      <a href="#">ARBETSPROV</a>
      <a href="#">TRANSTHORAKAL EKOKARDIOGRAFI, TTE</a>
      <a href="#">TRANSESOFAGEAL EKOKARDIOGRAFI, TEE</a>
      <a href="#">STRESS-EKO</a>
      <a href="#">MANNOMETRI</a>
    </div>
  </div>

  <div class="container-dd2">
    <nav class="kf">NUKLEARMEDICIN</nav>
    <div class="dropdown">
      <a href="#">MYOKARDSCINTIGRAFI</a>
      <a href="#">NJURSCINTIGRAFI</a>
      <a href="#">THYROIDEASCINTIGRAFI</a>
      <a href="#">HJÄRNSCINTIGRAFI</a>
      <a href="#">LUNGSCINTIGRAFI</a>
    </div>
  </div>
</div>

<div id="right">
  <h2>KLINISK FYSIOLOGI OCH NUKLEARMEDICIN</h2>
</div>

<script>
  const chat = document.getElementById("chat");
  const form = document.getElementById("form");
  const input = document.getElementById("input");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const fråga = input.value.trim();
    if (!fråga) return;

    input.value = "";
    history.push({ role: "user", content: fråga });
    append(">>", fråga, "user");

    const typingRef = append("AI", "Skriver svar…", "bot", true);

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: fråga })
      });

      if (!res.ok) {
        const txt = await res.text();
        console.error("API-fel:", res.status, txt);
        throw new Error(txt);
      }

      const data = await res.json();
      typingRef.remove();

      let suffix = "";
      if (Array.isArray(data.citations) && data.citations.length) {
        suffix = " (" + data.citations.map(c => `${c.label} s.${c.page}`).join(", ") + ")";
      }

      const svar = data.content + suffix;
      history.push({ role: "assistant", content: svar });
      append("AI", svar, "bot");

    } catch (err) {
      typingRef.remove();
      append("Bot", "Fel: " + err.message, "bot");
    }
  });

  const history = [];

  function append(namn, text, klass, typing = false) {
    const div = document.createElement("div");
    div.className = `msg ${klass}${typing ? " typing" : ""}`;

    const bub = document.createElement("div");
    bub.className = "bubble";
    const clean = text.replace(/【[^】]+】/gu, "");
    bub.textContent = `${namn}: ${clean}`;
    div.appendChild(bub);

    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div;
  }
</script>

</body>
</html>
